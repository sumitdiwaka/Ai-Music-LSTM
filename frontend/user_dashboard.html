<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Music Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tone.js and Midi.js for playback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glassmorphism { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="min-h-screen" style="background-image: url('https://www.transparenttextures.com/patterns/stardust.png');">
        <header class="bg-gray-900/50 backdrop-blur-sm shadow-lg sticky top-0 z-20">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">My Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <span id="welcome-message" class="text-gray-300 hidden md:block">Welcome!</span>
                    <button id="logout-btn" class="bg-pink-600 hover:bg-pink-700 text-white text-sm font-bold py-2 px-4 rounded-full">Logout</button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Profile Section -->
                <div class="lg:col-span-1">
                    <div class="glassmorphism rounded-2xl p-6 text-center">
                        <img id="profile-photo" class="w-32 h-32 rounded-full object-cover border-4 border-purple-500 mx-auto mb-4" src="https://placehold.co/128x128/374151/a78bfa?text=U" alt="User profile photo">
                        <h2 id="profile-fullname" class="text-2xl font-bold">User Name</h2>
                        <p id="profile-email" class="text-gray-400">user@example.com</p>
                        <p id="profile-phone" class="text-gray-400 text-sm mt-1"></p>
                        <button id="update-profile-btn" class="mt-4 text-sm text-purple-400 hover:underline">Update Profile</button>
                        <a href="http://127.0.0.1:5000/generator" class="mt-6 inline-block w-full text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 focus:ring-4 focus:outline-none focus:ring-purple-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Generate New Music</a>
                    </div>
                </div>

                <!-- Songs List Section -->
                <div class="lg:col-span-2">
                    <div class="glassmorphism rounded-2xl p-6">
                        <h3 class="text-2xl font-bold mb-6">My Generated Songs</h3>
                        <div id="song-list" class="space-y-4">
                            <p id="no-songs-message" class="text-gray-400">You haven't generated any songs yet. Click "Generate New Music" to start!</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Update Profile Modal -->
    <div id="update-modal" class="fixed inset-0 z-30 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="glassmorphism rounded-2xl shadow-lg p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center">Update Your Profile</h2>
            <form id="update-form">
                <div class="flex flex-col items-center mb-6">
                    <img id="update-photo-preview" class="w-24 h-24 rounded-full object-cover border-2 border-gray-600 mb-2" src="https://placehold.co/96x96/374151/a78bfa?text=Photo">
                    <label for="update-photo-upload" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-1 px-3 rounded-full">Change Photo</label>
                    <input id="update-photo-upload" type="file" class="hidden" accept="image/*">
                </div>
                <div class="mb-4"><label class="block mb-2 text-sm text-gray-300">Full Name</label><input type="text" id="update-fullname" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5" required></div>
                <div class="mb-4"><label class="block mb-2 text-sm text-gray-300">Phone</label><input type="tel" id="update-phone" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5"></div>
                <hr class="border-gray-600 my-6">
                <div class="mb-4"><label class="block mb-2 text-sm text-gray-300">Current Password</label><input type="password" id="current-password" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5"></div>
                <div class="mb-6"><label class="block mb-2 text-sm text-gray-300">New Password</label><input type="password" id="new-password" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5"></div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancel-update-btn" class="text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" class="text-white bg-gradient-to-r from-purple-500 to-pink-500 font-medium rounded-lg text-sm px-5 py-2.5">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 z-30 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="glassmorphism rounded-2xl shadow-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Delete Song</h3>
            <p id="delete-message" class="mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
            </div>
        </div>
    </div>

    <div id="message-container" class="fixed top-5 right-5 z-40"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // DOM Elements
            const welcomeMessage = document.getElementById('welcome-message');
            const profilePhoto = document.getElementById('profile-photo');
            const profileFullname = document.getElementById('profile-fullname');
            const profileEmail = document.getElementById('profile-email');
            const profilePhone = document.getElementById('profile-phone');
            const songList = document.getElementById('song-list');
            const noSongsMessage = document.getElementById('no-songs-message');
            const logoutBtn = document.getElementById('logout-btn');
            const updateProfileBtn = document.getElementById('update-profile-btn');
            const updateModal = document.getElementById('update-modal');
            const cancelUpdateBtn = document.getElementById('cancel-update-btn');
            const updateForm = document.getElementById('update-form');
            const deleteModal = document.getElementById('delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const deleteMessage = document.getElementById('delete-message');
            const messageContainer = document.getElementById('message-container');

            let newPhotoBase64 = null;
            let currentSongIdToDelete = null;
            let synth = null;
            let isPlaying = false;

            // --- Helper Functions ---
            async function authenticatedFetch(url, options = {}) {
                options.credentials = 'include';
                try {
                    const response = await fetch(url, options);
                    if (response.redirected || response.status === 401) {
                        window.location.href = 'http://127.0.0.1:5000/';
                        return null;
                    }
                    return response;
                } catch (err) {
                    console.error("Network Error:", err);
                    return null;
                }
            }

            function showToast(message, type) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `px-4 py-2 rounded-md shadow-lg text-sm font-medium ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
                messageContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // --- Main Data Loading ---
            async function loadDashboardData() {
                const userRes = await authenticatedFetch('http://127.0.0.1:5000/api/user');
                if (!userRes) return;
                const userData = await userRes.json();

                welcomeMessage.textContent = `Welcome, ${userData.fullname.split(' ')[0]}!`;
                profileFullname.textContent = userData.fullname;
                profileEmail.textContent = userData.email;
                profilePhone.textContent = userData.phone || '';
                if (userData.profile_photo) {
                    profilePhoto.src = userData.profile_photo;
                    document.getElementById('update-photo-preview').src = userData.profile_photo;
                }
                document.getElementById('update-fullname').value = userData.fullname;
                document.getElementById('update-phone').value = userData.phone || '';

                const songsRes = await authenticatedFetch('http://127.0.0.1:5000/api/songs');
                if (!songsRes) return;
                const songs = await songsRes.json();

                if (songs.length > 0) {
                    noSongsMessage.style.display = 'none';
                    songList.innerHTML = '';
                    songs.forEach(song => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-800/50 p-4 rounded-lg flex items-center justify-between';
                        div.innerHTML = `
                            <div>
                                <p class="font-semibold">${song.title}</p>
                                <p class="text-xs text-gray-400">Generated on: ${song.date_created}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button class="play-btn p-2 rounded-full bg-green-500 hover:bg-green-600 text-white" title="Play" data-midi="${song.midi_data}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                                </button>
                                <button class="download-btn p-2 rounded-full bg-blue-500 hover:bg-blue-600 text-white" title="Download" data-midi="${song.midi_data}" data-title="${song.title}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                </button>
                                <button class="delete-btn p-2 rounded-full bg-red-600 hover:bg-red-700 text-white" title="Delete" data-song-id="${song.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        `;
                        songList.appendChild(div);
                    });
                }
            }

            // --- Event Delegation (One listener for all buttons) ---
            songList.addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;

                // 1. Handle Download Click
                if (btn.classList.contains('download-btn')) {
                    const midiBase64 = btn.dataset.midi;
                    const title = btn.dataset.title;
                    if (midiBase64) {
                        const link = document.createElement('a');
                        link.href = `data:audio/midi;base64,${midiBase64}`;
                        link.download = `${title}.mid`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        showToast('Error: No MIDI data found.', 'error');
                    }
                }
                
                // 2. Handle Delete Click
                else if (btn.classList.contains('delete-btn')) {
                    currentSongIdToDelete = btn.dataset.songId;
                    document.getElementById('delete-message').textContent = "Are you sure you want to delete this song?";
                    deleteModal.classList.remove('hidden');
                }

                // 3. Handle Play Click (Simple Preview)
                else if (btn.classList.contains('play-btn')) {
                    const midiBase64 = btn.dataset.midi;
                    if (!midiBase64) return;
                    
                    await Tone.start();
                    if(isPlaying) {
                        Tone.Transport.stop();
                        Tone.Transport.cancel();
                        isPlaying = false;
                        return; // Stop if already playing
                    }

                    // Decode and play
                    const binaryString = atob(midiBase64);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
                    const midi = new Midi(bytes.buffer);
                    
                    if(!synth) synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    
                    const now = Tone.now() + 0.5;
                    midi.tracks.forEach(track => {
                        track.notes.forEach(note => {
                            synth.triggerAttackRelease(note.name, note.duration, note.time + now, note.velocity);
                        });
                    });
                    isPlaying = true;
                    setTimeout(() => isPlaying = false, midi.duration * 1000);
                }
            });

            // Delete Modal Logic
            cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', async () => {
                if (currentSongIdToDelete) {
                    const res = await authenticatedFetch(`http://127.0.0.1:5000/api/songs/delete/${currentSongIdToDelete}`, { method: 'DELETE' });
                    if (res && res.ok) {
                        showToast('Song deleted successfully.', 'success');
                        loadDashboardData();
                    } else {
                        showToast('Failed to delete song.', 'error');
                    }
                }
                deleteModal.classList.add('hidden');
            });

            // Profile Update Logic
            updateProfileBtn.addEventListener('click', () => updateModal.classList.remove('hidden'));
            cancelUpdateBtn.addEventListener('click', () => updateModal.classList.add('hidden'));
            document.getElementById('update-photo-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.getElementById('update-photo-preview').src = ev.target.result;
                        newPhotoBase64 = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            updateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const payload = {
                    fullname: document.getElementById('update-fullname').value,
                    phone: document.getElementById('update-phone').value,
                    current_password: document.getElementById('current-password').value,
                    new_password: document.getElementById('new-password').value,
                };
                if (newPhotoBase64) payload.profile_photo = newPhotoBase64;
                
                const res = await authenticatedFetch('http://127.0.0.1:5000/api/user/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res && res.ok) {
                    showToast('Profile updated!', 'success');
                    updateModal.classList.add('hidden');
                    loadDashboardData();
                } else {
                    showToast('Update failed. Check password.', 'error');
                }
            });

            logoutBtn.addEventListener('click', async () => {
                await authenticatedFetch('http://127.0.0.1:5000/api/logout', { method: 'POST' });
                window.location.href = 'http://127.0.0.1:5000/';
            });

            // Start
            loadDashboardData();
        });
    </script>
</body>
</html>